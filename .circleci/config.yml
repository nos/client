version: 2.1

orbs:
  codecov: codecov/codecov@1.0.5

references:
  workspace: &workspace ~/repo

  container_config: &container_config
    docker:
      - image: circleci/node:10.13.0
    working_directory: *workspace

  win_config: &win_config
    docker:
      - image: legiit/electron-builder-wine:node12
        environment:
          TARGET_ARCH: x64
    working_directory: *workspace

  mac_config: &mac_config
    macos:
      xcode: '10.3.0'
    working_directory: *workspace

commands:
  pre:
    description: 'Setting up and building environment'
    parameters:
      sudo:
        type: string
        default: ''
      windows:
        type: boolean
        default: false
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
            - v1-dependencies-{{ arch }}

      - run: << parameters.sudo >> apt-get -y update
      - run: << parameters.sudo >> apt-get -y install libusb-1.0-0
      - when:
          condition: <<parameters.windows>>
          steps:
            - run: apt-get -y install libudev-dev libudev-dev:i386 libusb-1.0-0-dev libusb-1.0-0-dev:i386
      - run: yarn

jobs:
  build_linux:
    <<: *container_config
    steps:
      - pre:
          sudo: 'sudo'
      - run: yarn dist --linux
      - save_cache:
          key: v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
  build_win:
    <<: *win_config
    steps:
      - pre:
          windows: true
      - run: yarn dist --win --x64 --ia32
      - save_cache:
          key: v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
  build_mac:
    <<: *mac_config
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
            - v1-dependencies-{{ arch }}
      - run: yarn
      - run: yarn dist --mac
      - save_cache:
          key: v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
  test:
    <<: *container_config
    steps:
      - pre:
          sudo: 'sudo'
      - run: yarn test
      - run: yarn codecov
      - codecov/upload:
          file: ./coverage/lcov.info

  deploy_win:
    <<: *win_config
    steps:
      - pre:
          windows: true
      - run: yarn release:win
      - persist_to_workspace:
          root: *workspace
          paths:
            - dist/*.*

  deploy_linux:
    <<: *container_config
    steps:
      - pre:
          sudo: 'sudo'
      - run: yarn release:linux
      - persist_to_workspace:
          root: *workspace
          paths:
            - dist/*.*

  deploy_mac:
    <<: *mac_config
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "package.json" }}
            - v1-dependencies-{{ arch }}
      - run: yarn
      - run: yarn release:mac
      - persist_to_workspace:
          root: *workspace
          paths:
            - ./dist/*.*

  calculate_checksums:
    <<: *container_config
    steps:
      - attach_workspace:
          at: *workspace
      - run: cd ./dist && shasum -a 256 *.*

workflows:
  version: 2
  build_win:
    jobs:
      - build_win
  build_linux:
    jobs:
      - build_linux
  build_mac:
    jobs:
      - build_mac
  unit_tests:
    jobs:
      - test
  deploy:
    jobs:
      - calculate_checksums:
          requires:
            - deploy_win
            - deploy_linux
            - deploy_mac
      - deploy_win:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /[v][0-9]+(\.[0-9]+)+.*/
      - deploy_linux:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /[v][0-9]+(\.[0-9]+)+.*/
      - deploy_mac:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /[v][0-9]+(\.[0-9]+)+.*/
